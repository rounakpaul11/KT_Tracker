<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drag & Drop KT Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f9fb;
      }
      /* Base styles for all KT sessions (Client-led) */
      .kt-base {
        color: white;
        font-weight: 700;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.1s;
        cursor: grab;
        position: relative;
      }

      /* Specific colors for each application KT session */
      .ec-session {
        background-color: #0077b6;
      } /* Deep Blue (P1) */
      .br-session {
        background-color: #00b4d8;
      } /* Medium Cyan (P2) */
      .geo-session {
        background-color: #0096c7;
      } /* Darker Cyan (P2) */
      .ov-session {
        background-color: #48cae4;
      } /* Light Cyan (P3) */
      .tp-session {
        background-color: #90e0ef; /* Lightest Cyan (P3) */
        color: #1a202c;
      }

      /* Status Overrides */
      .kt-done {
        background-color: #16a34a !important;
      } /* Dark Green */
      .kt-pending {
        background-color: #f97316 !important;
      } /* Dark Orange */

      .kt-status-icon {
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: 1.1em;
        font-weight: 900;
        line-height: 1;
        padding: 2px;
      }

      /* Internal Documentation & Learning - SHADES */
      .dnl-base {
        font-weight: 600;
        font-size: 0.8rem;
        font-style: italic;
        border: 1px dashed;
        cursor: grab; /* Made D&L sessions draggable */
      }
      .dnl-ec {
        background-color: #cde6f4;
        color: #0077b6;
        border-color: #0077b6;
      }
      .dnl-br {
        background-color: #ccecf4;
        color: #00b4d8;
        border-color: #00b4d8;
      }
      .dnl-geo {
        background-color: #c6e7f4;
        color: #0096c7;
        border-color: #0096c7;
      }
      .dnl-ov {
        background-color: #e0f4f9;
        color: #48cae4;
        border-color: #48cae4;
      }
      .dnl-tp {
        background-color: #f0f9fb;
        color: #90e0ef;
        border-color: #90e0ef;
      }
      /* Fallback for general D&L (Prep, Review, etc.) */
      .dnl-general {
        background-color: #e8f5e9;
        color: #388e3c;
        border-color: #388e3c;
        font-weight: 700; /* Added distinction for general prep/buffer */
        font-style: normal;
      }

      /* Drop target indication */
      .drag-over {
        border: 2px dashed #ff5733;
        background-color: #fff3e0 !important;
        box-shadow: 0 0 10px rgba(255, 87, 51, 0.5);
      }

      .table-cell {
        padding: 0.5rem;
        text-align: center;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.2;
        position: relative;
      }
      .kt-id-name {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        line-height: 1.1;
        padding: 2px 0;
        width: 100%; /* Important for drag area */
        height: 100%;
      }
      .kt-id {
        font-size: 0.9em;
        font-weight: 700;
        white-space: nowrap;
      }
      .kt-name {
        font-weight: 400;
        font-size: 0.75em;
        opacity: 0.9;
      }
      .time-slot-header {
        background-color: #0096c7;
        color: white;
        font-weight: 600;
        position: sticky;
        left: 0;
        z-index: 10;
      }

      /* Fixed width for Time Slot Column */
      .time-col {
        width: 120px;
        min-width: 120px;
      }

      /* BUFFER STYLES */
      #sessionBuffer {
        min-height: 100px;
        border: 2px dashed #9e9e9e;
        background-color: #f5f5f5;
        text-align: center;
        transition: all 0.2s ease-in-out;
        padding: 1rem;
      }
      .buffer-item {
        cursor: grab;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.1s;
        font-size: 0.8rem;
        padding: 0.5rem;
        line-height: 1.1;
        box-sizing: border-box;
        width: 100%; /* Ensure items take up full width in the flex container */
        max-width: 150px;
      }

      .undo-btn {
        background-color: #ff5733;
        color: white;
        font-weight: 600;
        transition: background-color 0.2s;
      }
      .undo-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      /* Progress Bar Styles */
      .progress-bar-container {
        height: 10px;
        border-radius: 5px;
        background-color: #e0e0e0;
        overflow: hidden;
        display: flex; /* Fix: Use flexbox for stable bar segment rendering */
      }
      .progress-done {
        background-color: #16a34a; /* Done - Green */
      }
      .progress-pending {
        background-color: #f97316; /* Pending - Orange */
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10">
      <h1 class="text-3xl font-extrabold text-[#0077B6] mb-2">
        KT Transition Timetable (Drag & Drop)
      </h1>
      <p class="text-gray-600 mb-6">
        Drag and drop any **KT Session** (blue boxes) to swap. Drag **D&L
        Sessions** (light boxes) to change internal time slots. **Click KT
        Sessions** to mark status.
      </p>

      <!-- Navigation Container -->
      <div
        class="flex flex-col lg:flex-row justify-between items-start mb-8 gap-6"
      >
        <!-- Deferred Sessions Buffer (Drop zone for KT removal and retrieval) -->
        <div
          id="sessionBuffer"
          class="p-4 rounded-lg flex-1 min-w-[300px] w-full lg:w-1/3 order-2 lg:order-1"
          ondragover="allowDrop(event)"
          ondrop="dropToBuffer(event)"
        >
          <!-- Content rendered by renderBuffer() -->
        </div>

        <!-- Navigation, Undo, and Legend -->
        <div class="flex flex-col gap-4 lg:w-2/3 order-1 lg:order-2">
          <div
            class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-lg border"
          >
            <button
              id="prevWeekBtn"
              class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-150 w-full sm:w-auto mb-3 sm:mb-0"
            >
              &larr; Previous Week
            </button>
            <h2
              id="weekIndicator"
              class="text-xl font-bold text-gray-800 text-center flex-grow mx-4"
            ></h2>
            <button
              id="nextWeekBtn"
              class="bg-[#0096C7] text-white py-2 px-4 rounded-lg font-semibold hover:bg-[#0077B6] transition duration-150 w-full sm:w-auto"
            >
              Next Week &rarr;
            </button>
          </div>

          <!-- UNDO BUTTON -->
          <button
            id="undoBtn"
            class="undo-btn py-2 px-4 rounded-lg font-semibold w-full sm:w-auto mx-auto hover:bg-red-700 transition duration-150"
            disabled
          >
            Undo Last Action
          </button>
          <button
            id="saveStateBtn"
            class="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold w-full sm:w-auto mx-auto hover:bg-green-700 transition duration-150"
          >
            Save State
          </button>

          <!-- Color Legend -->
          <div
            class="flex flex-wrap justify-center gap-4 text-sm font-semibold"
          >
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#0077B6] block"></span>
              <span>EC KT</span>
            </div>
            <div class="flex items-center space-x-1">
              <span
                class="w-4 h-4 rounded-full bg-[#CCECF4] block border border-[#00B4D8] border-dashed"
              ></span>
              <span>EC D&L</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#00B4D8] block"></span>
              <span>BR KT</span>
            </div>
            <div class="flex items-center space-x-1">
              <span
                class="w-4 h-4 rounded-full bg-[#C6E7F4] block border border-[#0096C7] border-dashed"
              ></span>
              <span>BR D&L</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#0096C7] block"></span>
              <span>GEO KT</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#48CAE4] block"></span>
              <span>OV KT</span>
            </div>
            <div class="flex items-center space-x-1">
              <span
                class="w-4 h-4 rounded-full bg-[#90E0EF] block border border-gray-400"
              ></span>
              <span>TP KT</span>
            </div>
            <div class="flex items-center space-x-1">
              <span
                class="w-4 h-4 rounded-full bg-[#E8F5E9] block border border-dashed border-[#388E3C]"
              ></span>
              <span>General D&L</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#16A34A] block"></span>
              <span>Done (Click)</span>
            </div>
            <div class="flex items-center space-x-1">
              <span class="w-4 h-4 rounded-full bg-[#F97316] block"></span>
              <span>Pending (Click)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Timetable Container -->
      <div class="overflow-x-auto">
        <!-- Reverted table styling for simplicity and alignment -->
        <table
          class="min-w-full divide-y divide-gray-200 border border-gray-200"
        >
          <thead class="bg-gray-100">
            <tr id="tableHeaders">
              <!-- Time Slot header has fixed width class -->
              <th
                class="time-slot-header time-col p-4 text-left text-sm font-medium uppercase tracking-wider rounded-tl-lg"
              >
                Time Slot (MST)
              </th>
              <!-- Date Headers will be dynamically added here -->
            </tr>
          </thead>
          <tbody id="scheduleBody" class="divide-y divide-gray-200">
            <!-- Schedule Rows will be dynamically added here -->
          </tbody>
        </table>
      </div>

      <!-- NEW: KT Progress Dashboard -->
      <div class="mt-10 pt-6 border-t border-gray-300">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
          KT Progress Dashboard
        </h2>
        <div
          id="overallProgress"
          class="mb-6 p-4 bg-blue-50 rounded-lg shadow-inner"
        >
          <!-- Overall progress bar and stats render here -->
        </div>
        <div
          id="appProgressContainer"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- Application status cards render here -->
        </div>
      </div>
      <!-- END NEW SECTION -->
    </div>

    <script>
      // --- GLOBAL DATA DEFINITIONS ---
      // --- SUPABASE INITIALIZATION ---
      const { createClient } = supabase;
      const supabaseClient = createClient(
        "https://wbvnerwbgiwieurfvwrb.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indidm5lcndiZ2l3aWV1cmZ2d3JiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDU4MDUsImV4cCI6MjA3NjEyMTgwNX0.uFPRKPGxYaCHDVIHQfRSwZdMYi57q6RowMp6wdUGv0c"
      );

      // Define global variables
      let currentWeekIndex = 0;
      let sessionLocations = {}; // Tracks KT sessions (EC01, BR01, etc.) location
      let sessionStatus = {}; // Tracks KT session status (DEFAULT, DONE, PENDING)
      let dnlOverrides = {}; // Tracks moved D&L content by location (W_D_S -> D&L Content String)
      let bufferSessions = []; // Tracks sessions moved to the deferral zone
      let currentSchedule = [];
      let historyStack = []; // Stores past states for Undo functionality

      const MAX_HISTORY = 20; // Limit history size
      const STORAGE_KEY = "ktScheduleState";
      const CELL_HEIGHT = 60; // Height of one hourly cell in pixels (used for reference)

      // Map application prefix to its D&L color class
      const dnlColorMap = {
        EC: "dnl-ec",
        BR: "dnl-br",
        GEO: "dnl-geo",
        OV: "dnl-ov",
        TP: "dnl-tp",
      };
      const APP_COLOR_MAP = {
        EC: "ec-session",
        BR: "br-session",
        GEO: "geo-session",
        OV: "ov-session",
        TP: "tp-session",
      };

      // --- NEW: Map of all KT sessions by application for progress tracking ---
      const ALL_KT_SESSIONS_MAP = {
        EC: [...Array(25)].map((_, i) => `EC${i + 1}`), // 25 sessions
        BR: [...Array(23)].map((_, i) => `BR${i + 1}`), // 23 sessions
        GEO: [...Array(10)].map((_, i) => `GEO${i + 1}`), // 10 sessions
        OV: [...Array(20)].map((_, i) => `OV${i + 1}`), // 20 sessions
        TP: [...Array(5)].map((_, i) => `TP${i + 1}`), // 5 sessions
      };
      const ALL_KT_SESSIONS = Object.values(ALL_KT_SESSIONS_MAP).flat();
      // --- END NEW DATA ---

      // Comprehensive details mapped from the CSV data
      const sessionDetails = {
        EC01: {
          id: "EC-S.001",
          name: "Business Overview & Purpose of the Application",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Full",
          desc: "Understanding how the application fits within the overall business context, business capabilities/processes modelled/mapped housed within the current system.",
        },
        EC02: {
          id: "EC-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        EC03: {
          id: "EC-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        EC04: {
          id: "EC-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        EC05: {
          id: "EC-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        EC06: {
          id: "EC-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        EC07: {
          id: "EC-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        EC08: {
          id: "EC-S.005",
          name: "Module Discovery & Deep Dive: Identity & Access Management",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Full",
          desc: "Ticketing Flow of IAM tickets, Approv Mechanism & Actors Involved, Privileges by User Group, User Mapping.",
        },
        EC09: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC10: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC11: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 3/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC12: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 4/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC13: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 5/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC14: {
          id: "EC-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 6/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC15: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC16: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC17: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 3/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC18: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 4/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC19: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 5/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC20: {
          id: "EC-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 6/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC21: {
          id: "EC-S.008",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 1/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC22: {
          id: "EC-S.008",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 2/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC23: {
          id: "EC-S.008",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Part 3/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC24: {
          id: "EC-S.009",
          name: "Discovery & Deep Dive: Non-Application Specific Modules",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Full",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        EC25: {
          id: "EC-S.010",
          name: "Final EC Wrap-up & Pending Questions",
          provider: "Trevor D., Jimmy K., Harain L.",
          part: "Full",
          desc: "Final application wrap-up and addressing any remaining queries or documentation gaps.",
        },

        BR01: {
          id: "BR-S.001",
          name: "Business Overview & Purpose of the Application",
          provider: "Jimmy K.",
          part: "Full",
          desc: "Understanding how the application fits within the overall business context, business capabilities/processes modelled/mapped housed within the current system.",
        },
        BR02: {
          id: "BR-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Jimmy K.",
          part: "Part 1/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        BR03: {
          id: "BR-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Jimmy K.",
          part: "Part 2/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        BR04: {
          id: "BR-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Jimmy K.",
          part: "Part 1/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        BR05: {
          id: "BR-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Jimmy K.",
          part: "Part 2/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        BR06: {
          id: "BR-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Jimmy K.",
          part: "Part 1/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        BR07: {
          id: "BR-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Jimmy K.",
          part: "Part 2/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        BR08: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 1/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR09: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 2/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR10: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 3/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR11: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 4/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR12: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 5/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR13: {
          id: "BR-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 6/6",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR14: {
          id: "BR-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 1/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR15: {
          id: "BR-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 2/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR16: {
          id: "BR-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 3/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR17: {
          id: "BR-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 4/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR18: {
          id: "BR-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 1/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR19: {
          id: "BR-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 2/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR20: {
          id: "BR-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 3/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR21: {
          id: "BR-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 4/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR22: {
          id: "BR-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Jimmy K.",
          part: "Part 5/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        BR23: {
          id: "BR-S.008",
          name: "Final BR Wrap-up & Pending Questions",
          provider: "Jimmy K.",
          part: "Full",
          desc: "Final application wrap-up and addressing any remaining queries or documentation gaps.",
        },

        GEO01: {
          id: "GEO-S.001",
          name: "Business Overview & Purpose of the Application",
          provider: "Harain L.",
          part: "Full",
          desc: "Understanding how the application fits within the overall business context, business capabilities/processes modelled/mapped housed within the current system.",
        },
        GEO02: {
          id: "GEO-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Harain L.",
          part: "Part 1/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        GEO03: {
          id: "GEO-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Harain L.",
          part: "Part 2/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        GEO04: {
          id: "GEO-S.003",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 1/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO05: {
          id: "GEO-S.003",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 2/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO06: {
          id: "GEO-S.003",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 3/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO07: {
          id: "GEO-S.004",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 1/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO08: {
          id: "GEO-S.004",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 2/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO09: {
          id: "GEO-S.004",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 3/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        GEO10: {
          id: "GEO-S.004",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 4/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },

        OV01: {
          id: "OV-S.001",
          name: "Business Overview & Purpose of the Application",
          provider: "Harain L.",
          part: "Full",
          desc: "Understanding how the application fits within the overall business context, business capabilities/processes modelled/mapped housed within the current system.",
        },
        OV02: {
          id: "OV-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Harain L.",
          part: "Part 1/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        OV03: {
          id: "OV-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Harain L.",
          part: "Part 2/2",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments & Hosting.",
        },
        OV04: {
          id: "OV-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Harain L.",
          part: "Part 1/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        OV05: {
          id: "OV-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Harain L.",
          part: "Part 2/2",
          desc: "Database Structures & How Integration Feeds into DB.",
        },
        OV06: {
          id: "OV-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Harain L.",
          part: "Part 1/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        OV07: {
          id: "OV-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Harain L.",
          part: "Part 2/2",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        OV08: {
          id: "OV-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 1/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV09: {
          id: "OV-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 2/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV10: {
          id: "OV-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 3/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV11: {
          id: "OV-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 4/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV12: {
          id: "OV-S.005",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 5/5",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV13: {
          id: "OV-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 1/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV14: {
          id: "OV-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 2/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV15: {
          id: "OV-S.006",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 3/3",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV16: {
          id: "OV-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 1/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV17: {
          id: "OV-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 2/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV18: {
          id: "OV-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 3/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV19: {
          id: "OV-S.007",
          name: "Module Discovery & Deep Dive: -Multiple-",
          provider: "Harain L.",
          part: "Part 4/4",
          desc: "Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },
        OV20: {
          id: "OV-S.008",
          name: "Final OV Wrap-up & Pending Questions",
          provider: "Harain L.",
          part: "Full",
          desc: "Final application wrap-up and addressing any remaining queries or documentation gaps.",
        },

        TP01: {
          id: "TP-S.001",
          name: "Business Overview & Purpose of the Application",
          provider: "Harain L.",
          part: "Full",
          desc: "Understanding how the application fits within the overall business context, business capabilities/processes modelled/mapped housed within the current system.",
        },
        TP02: {
          id: "TP-S.002",
          name: "Application Overview & Module Walkthrough",
          provider: "Harain L.",
          part: "Full",
          desc: "Understand the system, key modules, key processes/capabilities modelled within each module, Environments.",
        },
        TP03: {
          id: "TP-S.003",
          name: "System Context Revisit & Integration Landscape",
          provider: "Harain L.",
          part: "Full",
          desc: "System Context Revisit & Integration Landscape.",
        },
        TP04: {
          id: "TP-S.004",
          name: "Support – Roles, Responsibilities & Coordination",
          provider: "Harain L.",
          part: "Full",
          desc: "Define the RACI for Key Activities, SLAs Covered, Key Business Groups & Users, Key Workarounds Permitted, Key Business Stakeholders, Key other IT Dependencies.",
        },
        TP05: {
          id: "TP-S.005",
          name: "Discovery & Deep Dive (Includes IAM)",
          provider: "Harain L.",
          part: "Full",
          desc: "Ticketing Flow of IAM tickets, Approv Mechanism & Actors Involved, Privileges by User Group, User Mapping, Module Functionality, Standard Tasks within the Modules, Business Processes leveraging the module.",
        },

        // Dummy session for empty slots / placeholding
        EMPTY: {
          id: "Internal Prep",
          name: "Internal Preparation/Buffer",
          provider: "N/A",
          part: "Full",
          desc: "Reserved time for internal documentation, prep, or buffer time.",
        },
      };

      // Initial 4-slot per day schedule (used to define the structure/order)
      const initialOriginalKtSchedule = [
        {
          weekLabel: "Week 1: Oct 13 - Oct 17, 2025 (P1 BR/GEO Start)",
          dates: [
            "Mon (10/13)",
            "Tue (10/14)",
            "Wed (10/15)",
            "Thu (10/16)",
            "Fri (10/17)",
          ],
          slots: [
            ["EMPTY", "EMPTY", "BR01", "BR02", "BR04"], // KT 1 content
            [
              "D&L (Prep)",
              "D&L (Prep)",
              "D&L (BR01)",
              "D&L (BR02)",
              "D&L (BR04)",
            ], // D&L 1 content
            ["EMPTY", "EMPTY", "GEO01", "GEO02", "GEO03"], // KT 2 content
            [
              "D&L (Prep)",
              "D&L (Prep)",
              "D&L (GEO01)",
              "D&L (GEO02)",
              "D&L (GEO03)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel: "Week 2: Oct 20 - Oct 24, 2025 (P1 BR/GEO Acceleration)",
          dates: [
            "Mon (10/20)",
            "Tue (10/21)",
            "Wed (10/22)",
            "Thu (10/23)",
            "Fri (10/24)",
          ],
          slots: [
            ["BR05", "BR06", "BR07", "BR08", "BR09"], // KT 1 content
            [
              "D&L (BR05)",
              "D&L (BR06)",
              "D&L (BR07)",
              "D&L (BR08)",
              "D&L (BR09)",
            ], // D&L 1 content
            ["GEO04", "GEO05", "GEO06", "GEO07", "GEO08"], // KT 2 content
            [
              "D&L (GEO04)",
              "D&L (GEO05)",
              "D&L (GEO06)",
              "D&L (GEO07)",
              "D&L (GEO08)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel:
            "Week 3: Oct 27 - Oct 31, 2025 (P1 GEO Completion & BR Push)",
          dates: [
            "Mon (10/27)",
            "Tue (10/28)",
            "Wed (10/29)",
            "Thu (10/30)",
            "Fri (10/31)",
          ],
          slots: [
            ["BR10", "BR11", "BR12", "BR13", "BR14"], // KT 1 content
            [
              "D&L (BR10)",
              "D&L (BR11)",
              "D&L (BR12)",
              "D&L (BR13)",
              "D&L (BR14)",
            ], // D&L 1 content
            ["GEO09", "GEO10", "BR15", "BR16", "BR17"], // KT 2 content
            [
              "D&L (GEO09)",
              "D&L (GEO10)",
              "D&L (BR15)",
              "D&L (BR16)",
              "D&L (BR17)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel:
            "Week 4: Nov 3 - Nov 7, 2025 (P1 BR Completion & P2 EC Start)",
          dates: [
            "Mon (11/03)",
            "Tue (11/04)",
            "Wed (11/05)",
            "Thu (11/06)",
            "Fri (11/07)",
          ],
          slots: [
            ["BR18", "BR19", "BR20", "BR21", "BR22"], // KT 1 content
            [
              "D&L (BR18)",
              "D&L (BR19)",
              "D&L (BR20)",
              "D&L (BR21)",
              "D&L (BR22)",
            ], // D&L 1 content
            ["BR23", "EC01", "EC02", "EC03", "EC04"], // KT 2 content
            [
              "D&L (BR23)",
              "D&L (EC01)",
              "D&L (EC02)",
              "D&L (EC03)",
              "D&L (EC04)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel:
            "Week 5: Nov 10 - Nov 14, 2025 (P2 EC Focus & P3 OV Start)",
          dates: [
            "Mon (11/10)",
            "Tue (11/11)",
            "Wed (11/12)",
            "Thu (11/13)",
            "Fri (11/14)",
          ],
          slots: [
            ["EC05", "EC06", "EC07", "EC08", "EC09"], // KT 1 content
            [
              "D&L (EC05)",
              "D&L (EC06)",
              "D&L (EC07)",
              "D&L (EC08)",
              "D&L (EC09)",
            ], // D&L 1 content
            ["EC10", "EC11", "EC12", "OV01", "OV02"], // KT 2 content
            [
              "D&L (EC10)",
              "D&L (EC11)",
              "D&L (EC12)",
              "D&L (OV01)",
              "D&L (OV02)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel: "Week 6: Nov 17 - Nov 21, 2025 (P2 EC & P3 OV Push)",
          dates: [
            "Mon (11/17)",
            "Tue (11/18)",
            "Wed (11/19)",
            "Thu (11/20)",
            "Fri (11/21)",
          ],
          slots: [
            ["EC13", "EC14", "EC15", "EC16", "EC17"], // KT 1 content
            [
              "D&L (EC13)",
              "D&L (EC14)",
              "D&L (EC15)",
              "D&L (EC16)",
              "D&L (EC17)",
            ], // D&L 1 content
            ["OV03", "OV04", "OV05", "OV06", "OV07"], // KT 2 content
            [
              "D&L (OV03)",
              "D&L (OV04)",
              "D&L (OV05)",
              "D&L (OV06)",
              "D&L (OV07)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel:
            "Week 7: Nov 24 - Nov 28, 2025 (P2 EC Completion & P3 OV/TP Start)",
          dates: [
            "Mon (11/24)",
            "Tue (11/25)",
            "Wed (11/26)",
            "Thu (11/27)",
            "Fri (11/28)",
          ],
          slots: [
            ["EC18", "EC19", "EC20", "EC21", "EC22"], // KT 1 content
            [
              "D&L (EC18)",
              "D&L (EC19)",
              "D&L (EC20)",
              "D&L (EC21)",
              "D&L (EC22)",
            ], // D&L 1 content
            ["OV08", "OV09", "OV10", "OV11", "OV12"], // KT 2 content
            [
              "D&L (OV08)",
              "D&L (OV09)",
              "D&L (OV10)",
              "D&L (OV11)",
              "D&L (OV12)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel: "Week 8: Dec 1 - Dec 5, 2025 (P3 OV/TP Focus)",
          dates: [
            "Mon (12/01)",
            "Tue (12/02)",
            "Wed (12/03)",
            "Thu (12/04)",
            "Fri (12/05)",
          ],
          slots: [
            ["EC23", "EC24", "EC25", "OV13", "OV14"], // KT 1 content
            [
              "D&L (EC23)",
              "D&L (EC24)",
              "D&L (EC25)",
              "D&L (OV13)",
              "D&L (OV14)",
            ], // D&L 1 content
            ["TP01", "TP02", "TP03", "TP04", "TP05"], // KT 2 content
            [
              "D&L (TP01)",
              "D&L (TP02)",
              "D&L (TP03)",
              "D&L (TP04)",
              "D&L (TP05)",
            ], // D&L 2 content
          ],
        },
        {
          weekLabel:
            "Week 9: Dec 8 - Dec 12, 2025 (P3 OV Completion & Wrap-up)",
          dates: [
            "Mon (12/08)",
            "Tue (12/09)",
            "Wed (12/10)",
            "Thu (12/11)",
            "Fri (12/12)",
          ],
          slots: [
            ["OV15", "OV16", "OV17", "OV18", "OV19"], // KT 1 content
            [
              "D&L (OV15)",
              "D&L (OV16)",
              "D&L (OV17)",
              "D&L (OV18)",
              "D&L (OV19)",
            ], // D&L 1 content
            ["OV20", "PH01", "PH02", "PH03", "EMPTY"], // KT 2 content
            [
              "D&L (OV20)",
              "D&L (BR Wrap)",
              "D&L (Final)",
              "D&L (Final)",
              "D&L (Prep)",
            ], // D&L 2 content
          ],
        },
      ];

      // --- UPDATED: 9 hourly time slots (8:00 AM to 5:00 PM) ---
      const timeSlots = [
        "8:00 AM - 9:00 AM",
        "9:00 AM - 10:00 AM",
        "10:00 AM - 11:00 AM", // NEW KT 1 Start (Slot 2)
        "11:00 AM - 12:00 PM",
        "12:00 PM - 1:00 PM", // NEW D&L 1 Start (Slot 4)
        "1:00 PM - 2:00 PM",
        "2:00 PM - 3:00 PM", // NEW KT 2 Start (Slot 6)
        "3:00 PM - 4:00 PM",
        "4:00 PM - 5:00 PM", // NEW D&L 2 Start (Slot 8, 1 hour only)
      ];

      // --- NAVIGATION FUNCTIONS (Global Scope) ---

      function nextWeek() {
        if (currentWeekIndex < currentSchedule.length - 1) {
          currentWeekIndex++;
          renderSchedule();
        }
      }

      function prevWeek() {
        if (currentWeekIndex > 0) {
          currentWeekIndex--;
          renderSchedule();
        }
      }

      // --- CORE DRAG & DROP UTILITIES (Global Scope) ---

      function isValidDropTarget(slotIndex) {
        // UPDATED: Droppable start slots are 0 (8am D&L), 2 (10am KT 1), 4 (12pm D&L 1), 6 (2pm KT 2), 8 (4pm D&L 2)
        return [0, 2, 4, 6, 8].includes(slotIndex);
      }

      function getAppPrefix(session) {
        if (session.startsWith("EC")) return "EC";
        if (session.startsWith("BR")) return "BR";
        if (session.startsWith("GEO")) return "GEO";
        if (session.startsWith("OV")) return "OV";
        if (session.startsWith("TP")) return "TP";
        return null;
      }

      function getAppClass(session) {
        const prefix = getAppPrefix(session);
        if (prefix) return `${prefix.toLowerCase()}-session`;
        return "";
      }

      // Helper to determine if a session string refers to D&L time
      function isDnlSession(session) {
        return (
          session.startsWith("D&L (") ||
          session.startsWith("D&L (Prep)") ||
          session.startsWith("D&L (Final)") ||
          session.startsWith("D&L (BR Wrap)")
        );
      }

      function getDnlContext(session) {
        const match = session.match(/D&L \((.*?)\)/);
        if (match && sessionDetails[match[1]]) {
          return match[1]; // Returns the base KT session ID, e.g., 'EC01'
        }
        if (session.includes("Prep")) return "Internal Preparation Time";
        if (session.includes("Wrap")) return "BR Final Wrap-up Review";
        if (session.includes("Review")) return "KT GAP Review Documentation";
        if (session.includes("Q&A")) return "KT Final Q&A Documentation";
        return null;
      }

      function getDnlClass(appPrefix) {
        if (appPrefix && dnlColorMap[appPrefix]) {
          return dnlColorMap[appPrefix];
        }
        return "dnl-general";
      }

      function getSessionDisplay(session) {
        if (session === "SKIP")
          return {
            type: "Other",
            display: "SKIP",
            title: "Session covered by previous hour (Rowspan)",
          };

        const ktPrefix = getAppPrefix(session);

        // 1. Handle Client-led KT Sessions (or Placeholder Sessions)
        if (ktPrefix || session.startsWith("PH")) {
          const details = sessionDetails[session] || sessionDetails["EMPTY"];
          const isPlaceholder = session.startsWith("PH");

          let title = `KT Provider(s): ${details.provider}\nSession Name: ${details.name}\nKey Outcomes: ${details.desc}`;
          let sessionPart = details.part === "Full" ? "" : ` (${details.part})`;
          let newId = details.id;

          if (isPlaceholder) {
            title = `FIXED SESSION: ${details.name}`;
            newId = details.id;
            sessionPart = "";
          }

          const displayHtml = `
                    <div class="kt-id-name">
                        <span class="kt-id">${newId}${sessionPart}</span>
                        <span class="kt-name">${details.name}</span>
                    </div>
                `;

          return {
            type: isPlaceholder ? "PH" : "KT",
            display: displayHtml,
            title: title,
            appPrefix: ktPrefix,
            internalId: session,
          };
        }

        // 2. Handle Internal D&L/Prep Sessions (DYNAMIC)
        const dnlContext = getDnlContext(session);
        if (dnlContext) {
          const baseKtIdMatch = session.match(/D&L \((.*?)\)/);

          let baseAppPrefix = null;
          let displayContent = session;
          let title = `INTERNAL TIME: Dedicated to ${dnlContext}. Review, document, and stabilize knowledge.`;

          if (baseKtIdMatch) {
            const baseKtId = baseKtIdMatch[1];
            const baseDetails = sessionDetails[baseKtId];
            baseAppPrefix = getAppPrefix(baseKtId);
            if (baseDetails) {
              title = `INTERNAL D&L: Documentation & Practice for KT Session ${baseDetails.id} (${baseDetails.name}).`;
              displayContent = `D&L: ${baseDetails.id}`;
            }
          }

          return {
            type: "DNL",
            display: displayContent,
            title: title,
            appPrefix: baseAppPrefix,
            internalId: session, // Use full content string for drag ID
          };
        }

        // 3. Handle EMPTY slots
        if (session === "EMPTY") {
          return {
            type: "EMPTY",
            display: "",
            title: "Empty Slot - Ready to schedule a session here.",
          };
        }

        return { type: "Other", display: session, title: session };
      }

      // --- PROGRESS TRACKING FUNCTIONS (NEW) ---

      function calculateProgress() {
        const overall = {
          total: ALL_KT_SESSIONS.length,
          done: 0,
          pending: 0,
          default: 0,
        };
        const appData = {};

        for (const appPrefix in ALL_KT_SESSIONS_MAP) {
          const sessions = ALL_KT_SESSIONS_MAP[appPrefix];
          const total = sessions.length;
          let done = 0;
          let pending = 0;

          sessions.forEach((sessionId) => {
            const status = sessionStatus[sessionId] || "DEFAULT";
            if (status === "DONE") {
              done++;
            } else if (status === "PENDING") {
              pending++;
            }
          });

          appData[appPrefix] = {
            total,
            done,
            pending,
            default: total - done - pending,
          };

          overall.done += done;
          overall.pending += pending;
        }

        overall.default = overall.total - overall.done - overall.pending;
        return { overall, appData };
      }

      function renderProgress() {
        const { overall, appData } = calculateProgress();
        const overallContainer = document.getElementById("overallProgress");
        const appContainer = document.getElementById("appProgressContainer");

        // --- Render Overall Progress ---
        const donePercent =
          overall.total > 0 ? (overall.done / overall.total) * 100 : 0;
        const pendingPercent =
          overall.total > 0 ? (overall.pending / overall.total) * 100 : 0;

        overallContainer.innerHTML = `
                <h3 class="text-xl font-bold mb-3 text-blue-800">Overall KT Completion: ${
                  overall.done
                } / ${overall.total} Sessions Done</h3>
                <div class="progress-bar-container">
                    <div class="h-full progress-done" style="width: ${donePercent}%;"></div>
                    <div class="h-full progress-pending" style="width: ${pendingPercent}%;"></div>
                </div>
                <div class="mt-2 text-sm text-gray-700 font-semibold flex justify-between">
                    <span>Done: <span class="text-green-600">${
                      overall.done
                    } (${Math.round(donePercent)}%)</span></span>
                    <span>Pending: <span class="text-orange-600">${
                      overall.pending
                    } (${Math.round(pendingPercent)}%)</span></span>
                    <span>Not Started: ${overall.default}</span>
                </div>
            `;

        // --- Render App-Specific Cards ---
        appContainer.innerHTML = "";
        for (const appPrefix in appData) {
          const data = appData[appPrefix];
          const total = data.total;
          const donePercent = total > 0 ? (data.done / total) * 100 : 0;
          const pendingPercent = total > 0 ? (data.pending / total) * 100 : 0;

          // Map app classes to specific CSS background colors for the label
          let appBgColor = "";
          if (appPrefix === "EC") appBgColor = "#0077B6";
          else if (appPrefix === "BR") appBgColor = "#00B4D8";
          else if (appPrefix === "GEO") appBgColor = "#0096C7";
          else if (appPrefix === "OV") appBgColor = "#48CAE4";
          else if (appPrefix === "TP") appBgColor = "#90E0EF";
          else appBgColor = "#6B7280"; // Default gray

          const card = document.createElement("div");
          card.className =
            "bg-white p-4 rounded-lg shadow border border-gray-200";
          card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-lg font-bold text-gray-800">${appPrefix} KT Sessions</span>
                        <span class="text-xl font-extrabold text-white px-2 py-0.5 rounded" style="background-color: ${appBgColor}; ${
            appPrefix === "TP" ? "color: #1a202c;" : ""
          }">${total}</span>
                    </div>
                    <div class="progress-bar-container mb-2">
                        <div class="h-full progress-done" style="width: ${donePercent}%;"></div>
                        <div class="h-full progress-pending" style="width: ${pendingPercent}%;"></div>
                    </div>
                    <div class="mt-2 text-xs flex justify-between">
                        <span class="text-green-600 font-semibold">Done: ${
                          data.done
                        }</span>
                        <span class="text-orange-600 font-semibold">Pending: ${
                          data.pending
                        }</span>
                        <span class="text-gray-500 font-semibold">Not Started: ${
                          data.default
                        }</span>
                    </div>
                `;
          appContainer.appendChild(card);
        }
      }

      // --- HISTORY MANAGEMENT ---

      function updateUndoButton() {
        const undoBtn = document.getElementById("undoBtn");
        undoBtn.disabled = historyStack.length <= 1; // Disable if only initial state is present
      }

      function saveHistory() {
        const state = {
          // Deep clone current state to avoid reference conflicts later
          sessionLocations: JSON.parse(JSON.stringify(sessionLocations)),
          dnlOverrides: JSON.parse(JSON.stringify(dnlOverrides)),
          bufferSessions: JSON.parse(JSON.stringify(bufferSessions)),
          sessionStatus: JSON.parse(JSON.stringify(sessionStatus)),
        };
        historyStack.push(state);
        if (historyStack.length > MAX_HISTORY) {
          historyStack.shift(); // Remove oldest state
        }
        updateUndoButton();
      }

      function undoAction() {
        if (historyStack.length <= 1) {
          return; // Nothing to undo beyond the initial state
        }

        // Pop the current state (the one we want to undo)
        historyStack.pop();

        // Restore the *previous* state
        const previousState = historyStack[historyStack.length - 1];

        // CRITICAL FIX: Explicitly deep clone during restoration to ensure no reference conflicts.
        sessionLocations = JSON.parse(
          JSON.stringify(previousState.sessionLocations)
        );
        dnlOverrides = JSON.parse(JSON.stringify(previousState.dnlOverrides));
        bufferSessions = JSON.parse(
          JSON.stringify(previousState.bufferSessions)
        );
        sessionStatus = JSON.parse(JSON.stringify(previousState.sessionStatus));

        // Save the restored state (this overwrites local storage)
        saveState();

        renderSchedule();
      }

      // --- DRAG & DROP HANDLERS (Global Scope) ---

      function allowDrop(ev) {
        ev.preventDefault();
        const targetCell = ev.currentTarget.closest("td");
        const isBuffer = ev.currentTarget.id === "sessionBuffer";

        if (
          isBuffer ||
          (targetCell && targetCell.dataset.droppable === "true")
        ) {
          ev.currentTarget.classList.add("drag-over");
        }
      }

      function drag(ev, internalId, isKt) {
        ev.dataTransfer.setData("text/plain", internalId);
        // Add a flag to distinguish KT vs DNL for drop target validation
        ev.dataTransfer.setData(
          "application/json",
          JSON.stringify({ isKt: isKt })
        );

        // Add original location to drag data if dragging from schedule (KT or DNL)
        if (isKt) {
          const loc = sessionLocations[internalId];
          if (loc) {
            ev.dataTransfer.setData(
              "text/schedule-loc",
              `${loc.weekIndex}_${loc.dayIndex}_${loc.slotIndex}`
            );
          } else {
            // Dragging from buffer
            ev.dataTransfer.setData("text/schedule-loc", "BUFFER");
          }
        } else {
          // DNL sessions use the W_D_S string as their ID, which is the location
          ev.dataTransfer.setData("text/schedule-loc", internalId);
        }

        ev.dataTransfer.effectAllowed = "move";
      }

      function dragLeave(ev) {
        const target = ev.currentTarget;
        if (target) {
          target.classList.remove("drag-over");
        }
      }

      function dropToBuffer(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove("drag-over");

        saveHistory(); // Save state before change

        const draggedId = ev.dataTransfer.getData("text/plain");
        const draggedPayload = JSON.parse(
          ev.dataTransfer.getData("application/json")
        );
        const draggedIsKt = draggedPayload.isKt;
        const originalLocString = ev.dataTransfer.getData("text/schedule-loc");

        if (!draggedIsKt || draggedId.startsWith("PH")) {
          // Only KT sessions can be permanently deferred/removed
          const bufferDiv = document.getElementById("sessionBuffer");
          bufferDiv.innerHTML = `<p class="text-red-600 font-bold">ERROR: Only KT Sessions (blue boxes) can be deferred/removed.</p>`;
          setTimeout(() => {
            renderBuffer();
          }, 2500);
          // Revert the history save if the action failed
          historyStack.pop();
          updateUndoButton();
          return;
        }

        // 1. Clear session from schedule if it was scheduled
        if (originalLocString !== "BUFFER") {
          sessionLocations[draggedId] = null;
          // Set the original slot to EMPTY via dnlOverrides to ensure it renders correctly.
          dnlOverrides[originalLocString] = "EMPTY";
        }

        // 2. Add to buffer array (if not already present, prevents duplicates on accidental drag-and-drop within the buffer zone)
        if (!bufferSessions.includes(draggedId)) {
          bufferSessions.push(draggedId);
        }

        // 3. Show visual confirmation in the buffer div
        const bufferDiv = document.getElementById("sessionBuffer");
        bufferDiv.innerHTML = `<p class="text-green-600 font-bold">Session ${sessionDetails[draggedId].id} DEFERRED.</p>`;
        setTimeout(() => {
          renderBuffer();
        }, 1500);

        saveState();
        renderSchedule();
      }

      function drop(ev, wIdx, dIdx, sIdx) {
        ev.preventDefault();
        ev.currentTarget.classList.remove("drag-over");

        const draggedId = ev.dataTransfer.getData("text/plain");
        const draggedPayload = JSON.parse(
          ev.dataTransfer.getData("application/json")
        );
        const draggedIsKt = draggedPayload.isKt;
        const originalLocString = ev.dataTransfer.getData("text/schedule-loc"); // W_D_S or "BUFFER"

        const targetId = currentSchedule[wIdx].slots[sIdx][dIdx];

        if (!isValidDropTarget(sIdx)) return;
        if (draggedId.startsWith("PH") || targetId.startsWith("PH")) return;

        const isTargetDnlSlot = [0, 4, 8].includes(sIdx);
        const isTargetKtSlot = [2, 6].includes(sIdx);
        const targetLocId = `${wIdx}_${dIdx}_${sIdx}`;

        // Prevent illegal moves and save history before execution
        if (draggedIsKt && isTargetDnlSlot && originalLocString !== "BUFFER") {
          // KT dropped onto D&L slot is allowed
        } else if (!draggedIsKt && isTargetKtSlot) {
          // D&L dropped onto KT slot - FORBIDDEN
          return;
        }

        saveHistory(); // Save state before successful change

        // --- CORE STATE LOGIC ---

        if (draggedIsKt) {
          // KT session logic

          const draggedFromBuffer = originalLocString === "BUFFER";

          let originalLocA = null;
          if (!draggedFromBuffer) {
            const parts = originalLocString.split("_").map(Number);
            originalLocA = {
              weekIndex: parts[0],
              dayIndex: parts[1],
              slotIndex: parts[2],
            };
          }

          if (getAppPrefix(targetId)) {
            // SCENARIO 3: KT dropped onto KT slot (SWAP)

            // 1. Swap locations
            sessionLocations[targetId] = originalLocA;
            sessionLocations[draggedId] = {
              weekIndex: wIdx,
              dayIndex: dIdx,
              slotIndex: sIdx,
            };

            if (draggedFromBuffer) {
              // If A came from buffer, B moves to buffer
              bufferSessions = bufferSessions.filter((id) => id !== draggedId);
              bufferSessions.push(targetId);
              sessionLocations[targetId] = null;
            }
          } else {
            // SCENARIO 1/3: KT dropped onto D&L/EMPTY slot (MOVE)

            // 1. Move KT A to new location
            sessionLocations[draggedId] = {
              weekIndex: wIdx,
              dayIndex: dIdx,
              slotIndex: sIdx,
            };

            // 2. Handle original slot A
            if (originalLocA) {
              // If A came from schedule, its old slot becomes EMPTY
              const originalLocId = `${originalLocA.weekIndex}_${originalLocA.dayIndex}_${originalLocA.slotIndex}`;

              // We use the dnlOverrides map to explicitly set this slot to EMPTY
              dnlOverrides[originalLocId] = "EMPTY";
            } else if (draggedFromBuffer) {
              // If A came from buffer, remove A from buffer list
              bufferSessions = bufferSessions.filter((id) => id !== draggedId);
            }

            // 3. Handle target slot B (D&L/EMPTY) - Clear any existing D&L override at the target
            delete dnlOverrides[targetLocId];
          }
        } else {
          // DNL session logic

          const originalLocId = originalLocString;
          const draggedContent = targetId;
          const targetContent = draggedId;

          // If target is another D&L session, perform a swap.
          if (isDnlSession(targetId) || targetId === "EMPTY") {
            // SWAP/MOVE DNL A with DNL B or EMPTY
            dnlOverrides[targetLocId] = targetContent;
            // A's old spot reverts to Prep unless it was EMPTY, then it stays EMPTY
            if (currentSchedule[wIdx].slots[sIdx][dIdx] !== "EMPTY") {
              dnlOverrides[originalLocId] = "D&L (Prep)";
            } else {
              dnlOverrides[originalLocId] = draggedContent;
            }
          }
        }

        saveState();
        renderSchedule();
      }

      // --- STATUS HANDLER ---

      function toggleStatus(sessionId) {
        saveHistory(); // Save state before change

        const currentStatus = sessionStatus[sessionId] || "DEFAULT";

        let newStatus;
        if (currentStatus === "DEFAULT") {
          newStatus = "DONE";
        } else if (currentStatus === "DONE") {
          newStatus = "PENDING";
        } else {
          newStatus = "DEFAULT";
        }

        sessionStatus[sessionId] = newStatus;
        saveState();
        renderSchedule(); // Renders schedule AND updates dashboard
      }

      // Save session status to Supabase
      async function saveStatusToSupabase() {
        try {
          // Prepare data for upsert
          const statusData = Object.entries(sessionStatus).map(
            ([session_id, status]) => ({
              session_id,
              status,
            })
          );

          // Upsert all session statuses to kt_status table
          const { error } = await supabaseClient
            .from("kt_status")
            .upsert(statusData, { onConflict: "session_id" });

          if (error) {
            console.error("Error saving session status to Supabase:", error);
            alert("Failed to save session status to database.");
          } else {
            console.log("Session status saved to Supabase successfully.");
            alert("Session status saved successfully!");
          }
        } catch (e) {
          console.error("Error during Supabase save:", e);
          alert("An error occurred while saving session status.");
        }
      }

      // --- STATE MANAGEMENT ---
      // Helper function to save state
      // Helper function to save state
      function saveState() {
        try {
          // Save only non-status related state to local storage
          const state = {
            sessionLocations,
            dnlOverrides,
            bufferSessions,
            historyStack,
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error("Could not save state to local storage:", e);
        }
      }

      // Ensures PH slots cannot be moved/swapped
      function updatePHLocations() {
        // PH01 (BR Final Hour)
        sessionLocations["PH01"] = { weekIndex: 8, dayIndex: 2, slotIndex: 6 }; // 2pm slot (WAS slot 4)
        // PH02 (KT GAP Review)
        sessionLocations["PH02"] = { weekIndex: 8, dayIndex: 3, slotIndex: 6 }; // 2pm slot (WAS slot 4)
        // PH03 (KT FINAL Q&A)
        sessionLocations["PH03"] = { weekIndex: 8, dayIndex: 4, slotIndex: 6 }; // 2pm slot (WAS slot 4)
      }

      // Initialize or load state
      // Initialize or load state
      async function initSessionLocations() {
        const storedState = localStorage.getItem(STORAGE_KEY);
        let stateLoadedSuccessfully = false;

        if (storedState) {
          try {
            const state = JSON.parse(storedState);
            sessionLocations = state.sessionLocations || {};
            dnlOverrides = state.dnlOverrides || {};
            bufferSessions = state.bufferSessions || [];
            sessionStatus = state.sessionStatus || {};
            historyStack = state.historyStack || [];

            updatePHLocations();
            stateLoadedSuccessfully = true;
          } catch (e) {
            console.error(
              "Error loading state from local storage. Clearing corrupted data and starting fresh.",
              e
            );
            localStorage.removeItem(STORAGE_KEY);
          }
        }

        // Load sessionStatus from Supabase
        try {
          const { data, error } = await supabaseClient
            .from("kt_status")
            .select("session_id, status");
          if (error) {
            console.error("Error loading session status from Supabase:", error);
          } else if (data) {
            // Update sessionStatus with data from Supabase
            data.forEach(({ session_id, status }) => {
              sessionStatus[session_id] = status;
            });
          }
        } catch (e) {
          console.error("Error fetching session status from Supabase:", e);
        }

        if (
          !stateLoadedSuccessfully ||
          Object.keys(sessionLocations).length === 0
        ) {
          // Build the initial state from the source data
          sessionLocations = {};
          dnlOverrides = {};
          bufferSessions = [];
          // sessionStatus = {}; // Do not reset sessionStatus here to preserve Supabase data
          historyStack = [];

          initialOriginalKtSchedule.forEach((week, wIdx) => {
            week.slots[0].forEach((sessionId, dIdx) => {
              if (
                sessionId &&
                !sessionId.startsWith("D&L") &&
                sessionId !== "EMPTY"
              ) {
                sessionLocations[sessionId] = {
                  weekIndex: wIdx,
                  dayIndex: dIdx,
                  slotIndex: 2,
                };
              }
            });
            week.slots[2].forEach((sessionId, dIdx) => {
              if (
                sessionId &&
                !sessionId.startsWith("D&L") &&
                sessionId !== "EMPTY"
              ) {
                sessionLocations[sessionId] = {
                  weekIndex: wIdx,
                  dayIndex: dIdx,
                  slotIndex: 6,
                };
              }
            });
          });
          updatePHLocations();
        }

        if (historyStack.length === 0) {
          saveHistory();
        }
        saveState();
      }

      // Builds the display schedule based on the current sessionLocations state
      function buildDisplaySchedule() {
        const displaySchedule = initialOriginalKtSchedule.map((week, wIdx) => {
          const newSlots = Array(9)
            .fill(null)
            .map(() => Array(5).fill(null));

          // 1. Initialize all primary slots with the D&L fallback, EMPTY or SKIP
          for (let d = 0; d < 5; d++) {
            // Slot 0 (8:00 AM): New D&L/Prep time (2 hours)
            newSlots[0][d] = "D&L (Prep)";
            newSlots[1][d] = "SKIP";

            // Slot 2 (10:00 AM): New KT 1 slot (2 hours) -> Default to EMPTY
            newSlots[2][d] = "EMPTY";
            newSlots[3][d] = "SKIP";

            // Slot 4 (12:00 PM): New D&L 1 slot (2 hours)
            newSlots[4][d] = "D&L (Prep)";
            newSlots[5][d] = "SKIP";

            // Slot 6 (2:00 PM): New KT 2 slot (2 hours) -> Default to EMPTY
            newSlots[6][d] = "EMPTY";
            newSlots[7][d] = "SKIP";

            // Slot 8 (4:00 PM): New D&L 2 slot (1 hour)
            newSlots[8][d] = "D&L (Prep)";
          }

          return {
            weekLabel: week.weekLabel,
            dates: week.dates,
            slots: newSlots,
          };
        });

        // 2. Overlay KT sessionLocations and place linked D&L sessions
        for (const sessionId in sessionLocations) {
          const loc = sessionLocations[sessionId];
          if (loc && loc.weekIndex !== undefined) {
            const wIdx = loc.weekIndex;
            const dIdx = loc.dayIndex;
            const sIdx = loc.slotIndex;
            const ktRowspan = 2;

            // Mark the KT start cell
            displaySchedule[wIdx].slots[sIdx][dIdx] = sessionId;

            // Mark all subsequent KT cells as SKIP
            for (let i = 1; i < ktRowspan; i++) {
              if (sIdx + i < 9) {
                displaySchedule[wIdx].slots[sIdx + i][dIdx] = "SKIP";
              }
            }

            // Determine the associated D&L session slot (immediately following the KT)
            const dnlStartSlot = sIdx + ktRowspan; // Will be 4 or 8

            if (dnlStartSlot < 9) {
              let dnlContent = `D&L (${sessionId})`;
              let dnlRowspan = 0;

              if (dnlStartSlot === 4) {
                // 12pm slot (after 10am KT) -> 2 hours D&L
                dnlRowspan = 2;
              } else if (dnlStartSlot === 8) {
                // 4pm slot (after 2pm KT) -> 1 hour D&L
                dnlRowspan = 1;
              }

              if (dnlRowspan > 0) {
                displaySchedule[wIdx].slots[dnlStartSlot][dIdx] = dnlContent;

                // Mark subsequent D&L cells as SKIP
                for (let i = 1; i < dnlRowspan; i++) {
                  if (dnlStartSlot + i < 9) {
                    displaySchedule[wIdx].slots[dnlStartSlot + i][dIdx] =
                      "SKIP";
                  }
                }
              }
            }
          }
        }

        // 3. Apply D&L Overrides (must run last to override default D&L placement)
        for (const locId in dnlOverrides) {
          const [w, d, s] = locId.split("_").map(Number);
          if (displaySchedule[w]) {
            displaySchedule[w].slots[s][d] = dnlOverrides[locId];
          }
        }

        return displaySchedule;
      }

      function renderBuffer() {
        const bufferDiv = document.getElementById("sessionBuffer");

        // Content title/instructions
        let html = `
                <p class="text-red-600 font-bold text-lg mb-2">Deferral Zone: Drop KT Sessions here to remove.</p>
                <p class="text-gray-500 italic text-sm font-semibold mb-3">NOTE: Drag sessions from the stack below back to the schedule.</p>
                <div id="bufferStack" class="flex flex-wrap justify-start gap-2 pt-2 min-h-[50px] border-t border-gray-300">
            `;

        if (bufferSessions.length === 0) {
          html +=
            '<p class="text-gray-400 italic text-sm w-full">No sessions deferred.</p>';
        } else {
          bufferSessions.forEach((sessionId) => {
            const details = sessionDetails[sessionId];
            const sessionPart =
              details.part === "Full" ? "" : ` (${details.part})`;

            const title = `DRAG back to schedule: ${details.id}${sessionPart} - ${details.name}`;

            html += `
                        <div 
                            class="buffer-item kt-base ${getAppClass(
                              sessionId
                            )}"
                            title="${title}"
                            draggable="true"
                            data-internal-id="${sessionId}"
                            ondragstart="drag(event, '${sessionId}', true)">
                            <span class="kt-id">${
                              details.id
                            }${sessionPart}</span>
                            <span class="kt-name">${details.name}</span>
                        </div>
                    `;
          });
        }

        html += "</div>";
        bufferDiv.innerHTML = html;
      }

      function renderSchedule() {
        currentSchedule = buildDisplaySchedule();
        const week = currentSchedule[currentWeekIndex];
        const scheduleBody = document.getElementById("scheduleBody");
        const tableHeaders = document.getElementById("tableHeaders");
        const weekIndicator = document.getElementById("weekIndicator");
        const prevBtn = document.getElementById("prevWeekBtn");
        const nextBtn = document.getElementById("nextWeekBtn");

        // Update Indicator
        weekIndicator.textContent = week.weekLabel;

        // Update Undo Button status
        updateUndoButton();

        // Update Headers (Dates)
        tableHeaders.innerHTML = `
                <th class="time-slot-header time-col p-4 text-left text-sm font-medium uppercase tracking-wider rounded-tl-lg">Time Slot (MST)</th>
                ${week.dates
                  .map(
                    (date) =>
                      `<th class="p-4 text-sm font-medium text-gray-700 w-1/5">${date}</th>`
                  )
                  .join("")}
            `;

        // Update Body (Sessions)
        scheduleBody.innerHTML = "";
        week.slots.forEach((row, slotIndex) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";

          // Time Slot Header
          tr.innerHTML += `<td class="time-slot-header time-col table-cell p-3 font-semibold text-sm text-left rounded-none">${timeSlots[slotIndex]}</td>`;

          // Data Cells
          row.forEach((session, dayIndex) => {
            if (session === "SKIP") {
              return; // Skip rendering this cell; it is covered by the cell above (rowspan)
            }

            const sessionData = getSessionDisplay(session);

            let rowspan = 1;
            const isDropTarget = isValidDropTarget(slotIndex);

            // Determine rowspan based on start slot index (fixed 2 or 1 for this new version)
            if ([0, 2, 4, 6].includes(slotIndex)) {
              rowspan = 2; // 8-10, 10-12, 12-2, 2-4 are all 2-hour blocks
            } else if (slotIndex === 8) {
              rowspan = 1; // 4-5 is a 1-hour block
            }

            const td = document.createElement("td");
            // Ensure all day columns have the same width class
            td.className = "table-cell border w-1/5";
            td.setAttribute("rowspan", rowspan);
            td.setAttribute("title", sessionData.title);

            // Add the current location as the initial drag ID for DNL sessions
            let draggedId;
            let isKt = false;

            // Session Display Logic
            if (sessionData.type === "KT" || sessionData.type === "PH") {
              // KT Sessions are draggable, PH slots are not
              td.innerHTML = sessionData.display;
              isKt = true;

              // Apply status classes/icons
              const status = sessionStatus[session] || "DEFAULT";
              if (status === "DONE") {
                td.classList.add("kt-done");
                td.innerHTML += `<span class="kt-status-icon">✓</span>`;
              } else if (status === "PENDING") {
                td.classList.add("kt-pending");
                td.innerHTML += `<span class="kt-status-icon">!</span>`;
              }

              if (sessionData.type === "KT") {
                // Handler for starting the drag and status click
                td.setAttribute("draggable", "true");
                td.classList.add("kt-base", getAppClass(session));
                td.addEventListener("click", () => toggleStatus(session)); // Status click handler
                draggedId = sessionData.internalId;
              } else {
                // Fixed placeholder (PH) session
                td.classList.add(
                  "bg-gray-300",
                  "text-gray-700",
                  "font-semibold"
                );
              }
            } else if (sessionData.type === "DNL") {
              // DNL Sessions are draggable (No status tracking for DNL)
              const dnlColorClass = getDnlClass(sessionData.appPrefix);
              td.classList.add("dnl-base", dnlColorClass);
              td.innerHTML = sessionData.display;

              // Use W_D_S string as the unique ID for DNL moves
              draggedId = `${currentWeekIndex}_${dayIndex}_${slotIndex}`;

              td.setAttribute("draggable", "true");
              isKt = false;
            } else if (sessionData.type === "DNL_General") {
              // General D&L/Prep Sessions (also DNL type, but no specific app prefix)
              td.classList.add("dnl-base", "dnl-general");
              td.innerHTML = sessionData.display;

              draggedId = `${currentWeekIndex}_${dayIndex}_${slotIndex}`;
              td.setAttribute("draggable", "true");
              isKt = false;
            } else if (sessionData.type === "EMPTY") {
              td.classList.add("bg-gray-100", "text-gray-400", "italic");
              td.innerHTML = "Empty Slot";
            } else {
              td.classList.add("bg-gray-100", "text-gray-400");
              td.innerHTML = sessionData.display;
            }

            // Attach Dragstart listener for all draggable elements (KT and DNL)
            if (td.hasAttribute("draggable")) {
              td.addEventListener("dragstart", (ev) =>
                drag(ev, draggedId, isKt)
              );
            }

            // Base Droppable Setup (Only the start of blocks is droppable)
            if (isDropTarget) {
              td.dataset.droppable = "true";
              td.addEventListener("dragover", (ev) => allowDrop(ev));
              td.addEventListener("dragleave", (ev) => dragLeave(ev));
              td.addEventListener("drop", (ev) =>
                drop(ev, currentWeekIndex, dayIndex, slotIndex)
              );
            }

            // Add the cell
            tr.appendChild(td);
          });
          scheduleBody.appendChild(tr);
        });

        // Render Buffer (updates visual stack)
        renderBuffer();

        // Render Progress Dashboard
        renderProgress(); // Renders the new dashboard section

        // Update Navigation Buttons
        prevBtn.disabled = currentWeekIndex === 0;
        nextBtn.disabled = currentWeekIndex === currentSchedule.length - 1;
        prevBtn.classList.toggle("opacity-50", prevBtn.disabled);
        nextBtn.classList.toggle("opacity-50", nextBtn.disabled);
      }

      // --- WRAPPER FOR DOM DEPENDENT LOGIC ---

      // --- WRAPPER FOR DOM DEPENDENT LOGIC ---
      document.addEventListener("DOMContentLoaded", async () => {
        // Existing event listeners
        document
          .getElementById("nextWeekBtn")
          .addEventListener("click", nextWeek);
        document
          .getElementById("prevWeekBtn")
          .addEventListener("click", prevWeek);
        document
          .getElementById("undoBtn")
          .addEventListener("click", undoAction);

        // New event listener for Save State button
        document
          .getElementById("saveStateBtn")
          .addEventListener("click", saveStatusToSupabase);

        // Attach buffer listeners
        const buffer = document.getElementById("sessionBuffer");
        buffer.addEventListener("dragover", (ev) => allowDrop(ev));
        buffer.addEventListener("dragleave", (ev) => dragLeave(ev));
        buffer.addEventListener("drop", dropToBuffer);

        // Initial setup and render (NOW AWAITS the async init)
        await initSessionLocations();
        renderSchedule();
      }); // End of DOMContentLoaded
    </script>
  </body>
</html>
